trigger:
  - master

pr: none

stages:
  - stage: 'notebook_tests'
    displayName: 'notebook tests'

    jobs:
      - job: 'test_notebooks'
        displayName: 'test notebooks linux'
        timeoutInMinutes: 30
        pool:
          vmImage: 'ubuntu-18.04'
        steps:
          - checkout: self
            submodules: true
          - bash: echo "##vso[task.prependpath]$CONDA/bin"
            displayName: 'add conda to PATH'
          - bash: |
             set -ex
             conda config --set always_yes yes --set changeps1 no
             conda env create -f ess-notebook-latest.yml
             source activate ess-notebook-latest
             git clone https://github.com/scipp/ess-notebooks-data.git data
             python make_config.py ${PWD}/data
             mkdir tests
             cp dataconfig.py tests/
             find . -not -path "*/\.*" -type f -name "*.ipynb"\
              | xargs jupyter nbconvert --to python --output-dir tests\
              --RegexRemovePreprocessor.patterns="['^# exclude-from-export']"
             test_output=notebooks.xml
             touch $test_output
             echo "\<\?xml\ version\=\"1.0\"\ encoding\=\"UTF-8\"\?\>\<testsuites\>\<testsuite\ name\=\"suite\"\>" >> $test_output
             exclude_list=()
             for f in tests/*.py; do 
                 found=0
                 for g in "${exclude_list[@]}" ; do
                     [ "$f" = "tests/$g" ] && found=1
                 done
                 [ "$found" = 0 ] && python "$f"
                 echo "\<testcase\ classname\=\"class\"\ name\=\"$f\"\>\<failure\ message\=\"$f\ failed\"/\>\</testcase\>" >> $test_output
             done
             echo "\</testsuite\>\</testsuites\>" >> $test_output
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'notebooks.xml'
              failTaskOnFailedTests: true
  - stage: 'make_sphinx_documentation'
    displayName: 'make sphinx documentation'

    jobs:
      - template: documentation_build.yml
  - stage: "deploy_documentation"
    displayName: "deploy documentation"

    jobs:
      - template: documentation_deploy.yml
